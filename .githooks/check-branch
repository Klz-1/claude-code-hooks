#!/bin/bash
# Periodic Branch Checker
# Can be run manually or via cron to ensure you're on the right branch

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Clear screen for better visibility (optional, comment out if not desired)
# clear

# Get current branch
if ! git rev-parse --git-dir >/dev/null 2>&1; then
    echo -e "${RED}[ERROR]${NC} Not in a git repository"
    exit 1
fi

CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
GIT_ROOT=$(git rev-parse --show-toplevel)

# Banner
echo ""
echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}â•‘           GIT BRANCH STATUS CHECK                      â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Show repository
REPO_NAME=$(basename "$GIT_ROOT")
echo -e "${BLUE}  ğŸ“ Repository:${NC} $REPO_NAME"
echo -e "${BLUE}  ğŸ“ Location:${NC} $GIT_ROOT"
echo ""

# Show current branch with visual indicator
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
if [[ "$CURRENT_BRANCH" == "main" ]] || [[ "$CURRENT_BRANCH" == "master" ]]; then
    echo -e "  ${RED}âš ï¸  PROTECTED BRANCH${NC}"
    echo -e "  ${RED}âœ  $CURRENT_BRANCH${NC}"
    echo ""
    echo -e "  ${YELLOW}âš¡ Warning: You are on a protected branch!${NC}"
    echo -e "  ${YELLOW}   Avoid making direct commits here.${NC}"
    echo -e "  ${YELLOW}   Consider creating a feature branch.${NC}"
elif [[ "$CURRENT_BRANCH" == "develop" ]] || [[ "$CURRENT_BRANCH" == "staging" ]]; then
    echo -e "  ${YELLOW}âš¡ SHARED BRANCH${NC}"
    echo -e "  ${YELLOW}âœ  $CURRENT_BRANCH${NC}"
    echo ""
    echo -e "  ${BLUE}ğŸ’¡ Note: This is a shared branch.${NC}"
    echo -e "  ${BLUE}   Coordinate with your team before pushing.${NC}"
else
    echo -e "  ${GREEN}âœ“ FEATURE BRANCH${NC}"
    echo -e "  ${GREEN}âœ  $CURRENT_BRANCH${NC}"
fi
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Check remote tracking
if git rev-parse @{u} >/dev/null 2>&1; then
    REMOTE_BRANCH=$(git rev-parse --abbrev-ref --symbolic-full-name @{u})

    # Count commits ahead/behind
    AHEAD=$(git rev-list --count @{u}..HEAD 2>/dev/null || echo 0)
    BEHIND=$(git rev-list --count HEAD..@{u} 2>/dev/null || echo 0)

    echo -e "${BLUE}  ğŸŒ Remote Tracking${NC}"
    echo -e "  â”œâ”€ Tracking: $REMOTE_BRANCH"

    if [[ $AHEAD -gt 0 ]] && [[ $BEHIND -gt 0 ]]; then
        echo -e "  â”œâ”€ Status: ${YELLOW}Diverged${NC}"
        echo -e "  â”œâ”€ ${GREEN}â†‘ $AHEAD commit(s) ahead${NC}"
        echo -e "  â””â”€ ${YELLOW}â†“ $BEHIND commit(s) behind${NC}"
        echo ""
        echo -e "  ${YELLOW}ğŸ’¡ Action needed:${NC} Pull or rebase to sync with remote"
    elif [[ $AHEAD -gt 0 ]]; then
        echo -e "  â”œâ”€ Status: ${GREEN}Ahead${NC}"
        echo -e "  â””â”€ ${GREEN}â†‘ $AHEAD unpushed commit(s)${NC}"
        echo ""
        echo -e "  ${BLUE}ğŸ’¡ Ready to push:${NC} git push"
    elif [[ $BEHIND -gt 0 ]]; then
        echo -e "  â”œâ”€ Status: ${YELLOW}Behind${NC}"
        echo -e "  â””â”€ ${YELLOW}â†“ $BEHIND commit(s) behind remote${NC}"
        echo ""
        echo -e "  ${YELLOW}ğŸ’¡ Action needed:${NC} git pull"
    else
        echo -e "  â””â”€ Status: ${GREEN}âœ“ Up to date${NC}"
    fi
else
    echo -e "${BLUE}  ğŸŒ Remote Tracking${NC}"
    echo -e "  â””â”€ ${YELLOW}No remote tracking branch${NC}"
    echo ""
    echo -e "  ${BLUE}ğŸ’¡ To push:${NC} git push -u origin $CURRENT_BRANCH"
fi

echo ""

# Check working directory status
MODIFIED=$(git status --porcelain 2>/dev/null | grep -E '^( M|M )' | wc -l | tr -d ' ')
ADDED=$(git status --porcelain 2>/dev/null | grep -E '^(A |AM)' | wc -l | tr -d ' ')
DELETED=$(git status --porcelain 2>/dev/null | grep -E '^( D|D )' | wc -l | tr -d ' ')
UNTRACKED=$(git status --porcelain 2>/dev/null | grep -E '^\?\?' | wc -l | tr -d ' ')
TOTAL=$((MODIFIED + ADDED + DELETED + UNTRACKED))

echo -e "${BLUE}  ğŸ“Š Working Directory${NC}"

if [[ $TOTAL -eq 0 ]]; then
    echo -e "  â””â”€ ${GREEN}âœ“ Clean (no changes)${NC}"
else
    echo -e "  â”œâ”€ ${YELLOW}$TOTAL file(s) with changes${NC}"
    [[ $MODIFIED -gt 0 ]] && echo -e "  â”œâ”€ ${YELLOW}Modified: $MODIFIED${NC}"
    [[ $ADDED -gt 0 ]] && echo -e "  â”œâ”€ ${GREEN}Added: $ADDED${NC}"
    [[ $DELETED -gt 0 ]] && echo -e "  â”œâ”€ ${RED}Deleted: $DELETED${NC}"
    [[ $UNTRACKED -gt 0 ]] && echo -e "  â””â”€ ${BLUE}Untracked: $UNTRACKED${NC}"

    echo ""
    echo -e "  ${BLUE}ğŸ’¡ View details:${NC} git status"
fi

echo ""

# Check for stashed changes
STASHED=$(git stash list 2>/dev/null | wc -l | tr -d ' ')

if [[ $STASHED -gt 0 ]]; then
    echo -e "${BLUE}  ğŸ“¦ Stashed Changes${NC}"
    echo -e "  â””â”€ ${YELLOW}$STASHED stash(es) available${NC}"
    echo ""
    echo -e "  ${BLUE}ğŸ’¡ View stashes:${NC} git stash list"
    echo ""
fi

# Show last commit
echo -e "${BLUE}  ğŸ“ Last Commit${NC}"
LAST_COMMIT=$(git log -1 --pretty=format:"  â”œâ”€ %h - %s" 2>/dev/null)
LAST_AUTHOR=$(git log -1 --pretty=format:"  â”œâ”€ Author: %an" 2>/dev/null)
LAST_DATE=$(git log -1 --pretty=format:"  â””â”€ %ar" 2>/dev/null)

echo -e "$LAST_COMMIT"
echo -e "$LAST_AUTHOR"
echo -e "$LAST_DATE"
echo ""

# Show upcoming reminders
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}  ğŸ’¡ Quick Reminders${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# Branch naming reminder
if [[ ! "$CURRENT_BRANCH" =~ ^(main|master|develop|staging|production)$ ]]; then
    if [[ "$CURRENT_BRANCH" =~ ^(feature|bugfix|hotfix|release|chore|docs|test)/ ]]; then
        echo -e "  ${GREEN}âœ“${NC} Branch name follows convention"
    else
        echo -e "  ${YELLOW}âš ${NC} Consider following branch naming convention:"
        echo -e "     feature/*, bugfix/*, hotfix/*, chore/*"
    fi
fi

# Commit frequency reminder
COMMITS_TODAY=$(git log --since="midnight" --oneline 2>/dev/null | wc -l | tr -d ' ')
if [[ $COMMITS_TODAY -eq 0 ]]; then
    echo -e "  ${BLUE}ğŸ’¡${NC} No commits today - commit often to save progress!"
elif [[ $COMMITS_TODAY -gt 10 ]]; then
    echo -e "  ${GREEN}âœ“${NC} $COMMITS_TODAY commits today - great progress!"
else
    echo -e "  ${GREEN}âœ“${NC} $COMMITS_TODAY commit(s) today"
fi

# Time since last commit
LAST_COMMIT_TIME=$(git log -1 --pretty=format:"%ct" 2>/dev/null)
if [[ -n "$LAST_COMMIT_TIME" ]]; then
    HOURS_SINCE_COMMIT=$(( ($(date +%s) - LAST_COMMIT_TIME) / 3600 ))
else
    HOURS_SINCE_COMMIT=0
fi

if [[ $HOURS_SINCE_COMMIT -gt 24 ]]; then
    echo -e "  ${YELLOW}âš ${NC} Last commit was $HOURS_SINCE_COMMIT hours ago"
    echo -e "     Consider committing your current progress"
fi

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Optional: Set this up in cron to run periodically
# Add to crontab: */30 * * * * cd /path/to/repo && /path/to/.githooks/check-branch
