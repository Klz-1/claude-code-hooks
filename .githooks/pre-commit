#!/bin/bash
# Git Pre-Commit Hook
# Runs quality checks before allowing a commit

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}[PRE-COMMIT]${NC} Running pre-commit checks..."

# Get the root directory
GIT_ROOT=$(git rev-parse --show-toplevel)
cd "$GIT_ROOT"

ERRORS=0

# 1. Check for secrets/credentials in staged files
echo -e "${BLUE}[CHECK]${NC} Scanning for secrets..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

SECRET_PATTERNS=(
    "password\s*=\s*['\"][^'\"]+['\"]"
    "api[_-]?key\s*=\s*['\"][^'\"]+['\"]"
    "secret\s*=\s*['\"][^'\"]+['\"]"
    "token\s*=\s*['\"][^'\"]+['\"]"
    "AWS_SECRET_ACCESS_KEY"
    "PRIVATE[_-]KEY"
    "BEGIN RSA PRIVATE KEY"
    "BEGIN OPENSSH PRIVATE KEY"
)

for file in $STAGED_FILES; do
    if [[ -f "$file" ]]; then
        for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -qE "$pattern" "$file" 2>/dev/null; then
                echo -e "${RED}[BLOCKED]${NC} Potential secret found in: $file"
                echo -e "${YELLOW}         Pattern: $pattern${NC}"
                ERRORS=$((ERRORS + 1))
            fi
        done
    fi
done

# 2. Check for debugging statements
echo -e "${BLUE}[CHECK]${NC} Checking for debug statements..."
DEBUG_PATTERNS=(
    "console\.log\("
    "console\.debug\("
    "debugger;"
    "print\("
    "var_dump\("
)

for file in $STAGED_FILES; do
    if [[ "$file" =~ \.(js|ts|jsx|tsx)$ ]] && [[ -f "$file" ]]; then
        for pattern in "${DEBUG_PATTERNS[@]}"; do
            if grep -qE "$pattern" "$file" 2>/dev/null; then
                echo -e "${YELLOW}[WARNING]${NC} Debug statement found in: $file"
                echo -e "${YELLOW}           Pattern: $pattern${NC}"
                # Warning only, don't block
            fi
        done
    fi
done

# 3. Check for large files (> 5MB)
echo -e "${BLUE}[CHECK]${NC} Checking for large files..."
MAX_SIZE=$((5 * 1024 * 1024)) # 5MB in bytes

for file in $STAGED_FILES; do
    if [[ -f "$file" ]]; then
        size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
        if [[ $size -gt $MAX_SIZE ]]; then
            size_mb=$((size / 1024 / 1024))
            echo -e "${RED}[BLOCKED]${NC} Large file detected: $file (${size_mb}MB)"
            echo -e "${YELLOW}         Consider using Git LFS for large files${NC}"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# 4. Lint staged JavaScript/TypeScript files
if command -v npm >/dev/null 2>&1 && [[ -f "package.json" ]]; then
    LINT_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|ts|jsx|tsx)$' || true)

    if [[ -n "$LINT_FILES" ]]; then
        echo -e "${BLUE}[CHECK]${NC} Running ESLint on staged files..."

        # Check if eslint is available
        if npm run lint:staged --silent 2>/dev/null || npx eslint --version >/dev/null 2>&1; then
            for file in $LINT_FILES; do
                if [[ -f "$file" ]]; then
                    if ! npx eslint "$file" 2>/dev/null; then
                        echo -e "${RED}[FAILED]${NC} ESLint errors in: $file"
                        ERRORS=$((ERRORS + 1))
                    fi
                fi
            done
        else
            echo -e "${YELLOW}[SKIP]${NC} ESLint not available"
        fi
    fi
fi

# 5. Format staged files with Prettier
if command -v npm >/dev/null 2>&1 && [[ -f "package.json" ]]; then
    FORMAT_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|ts|jsx|tsx|json|md|css|scss)$' || true)

    if [[ -n "$FORMAT_FILES" ]]; then
        echo -e "${BLUE}[CHECK]${NC} Checking formatting with Prettier..."

        if command -v prettier >/dev/null 2>&1 || npx prettier --version >/dev/null 2>&1; then
            for file in $FORMAT_FILES; do
                if [[ -f "$file" ]]; then
                    if ! npx prettier --check "$file" >/dev/null 2>&1; then
                        echo -e "${YELLOW}[AUTO-FIX]${NC} Formatting: $file"
                        npx prettier --write "$file" >/dev/null 2>&1
                        git add "$file"
                    fi
                fi
            done
        else
            echo -e "${YELLOW}[SKIP]${NC} Prettier not available"
        fi
    fi
fi

# 6. Type-check TypeScript files
if command -v npm >/dev/null 2>&1 && [[ -f "tsconfig.json" ]]; then
    TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx)$' || true)

    if [[ -n "$TS_FILES" ]]; then
        echo -e "${BLUE}[CHECK]${NC} Running TypeScript type-check..."

        if npx tsc --version >/dev/null 2>&1; then
            if ! npx tsc --noEmit 2>&1 | head -20; then
                echo -e "${RED}[FAILED]${NC} TypeScript type errors detected"
                ERRORS=$((ERRORS + 1))
            fi
        else
            echo -e "${YELLOW}[SKIP]${NC} TypeScript not available"
        fi
    fi
fi

# 7. Check for TODOs/FIXMEs in production code
echo -e "${BLUE}[CHECK]${NC} Checking for TODO/FIXME comments..."
TODO_COUNT=0

for file in $STAGED_FILES; do
    if [[ "$file" =~ \.(js|ts|jsx|tsx)$ ]] && [[ -f "$file" ]]; then
        if grep -nE "(TODO|FIXME|XXX|HACK)" "$file" 2>/dev/null; then
            TODO_COUNT=$((TODO_COUNT + 1))
        fi
    fi
done

if [[ $TODO_COUNT -gt 0 ]]; then
    echo -e "${YELLOW}[WARNING]${NC} Found $TODO_COUNT file(s) with TODO/FIXME comments"
    echo -e "${YELLOW}           Review before committing to production${NC}"
fi

# 8. Verify no merge conflict markers
echo -e "${BLUE}[CHECK]${NC} Checking for merge conflict markers..."
for file in $STAGED_FILES; do
    if [[ -f "$file" ]] && grep -qE '^(<<<<<<<|=======|>>>>>>>)' "$file" 2>/dev/null; then
        echo -e "${RED}[BLOCKED]${NC} Merge conflict markers found in: $file"
        ERRORS=$((ERRORS + 1))
    fi
done

# Final result
echo ""
if [[ $ERRORS -gt 0 ]]; then
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}[BLOCKED]${NC} Pre-commit checks failed with $ERRORS error(s)"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "Fix the errors above and try again."
    echo "To bypass this hook (NOT recommended), use: git commit --no-verify"
    exit 1
else
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}[SUCCESS]${NC} All pre-commit checks passed!"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    exit 0
fi
