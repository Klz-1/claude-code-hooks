#!/bin/bash
# Git Pre-Rebase Hook
# Safety checks before rebasing

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}[PRE-REBASE]${NC} Running safety checks..."

# Get arguments
UPSTREAM=$1
BRANCH=${2:-$(git rev-parse --abbrev-ref HEAD)}

# 1. Prevent rebasing main/master
if [[ "$UPSTREAM" == "main" ]] || [[ "$UPSTREAM" == "master" ]]; then
    echo -e "${RED}[WARNING]${NC} You are attempting to rebase onto $UPSTREAM"
    echo -e "${YELLOW}         This will rewrite history of $UPSTREAM${NC}"

    # Check for non-interactive mode
    if [[ ! -t 0 ]] || [[ -n "$CI" ]] || [[ -n "$GITHUB_ACTIONS" ]] || [[ -n "$GITLAB_CI" ]]; then
        if [[ "$ALLOW_REBASE_MAIN" == "1" ]]; then
            echo -e "${YELLOW}[ALLOWED]${NC} Non-interactive mode with ALLOW_REBASE_MAIN=1"
        else
            echo -e "${RED}[BLOCKED]${NC} Cannot rebase onto $UPSTREAM in non-interactive mode"
            echo -e "${YELLOW}           Set ALLOW_REBASE_MAIN=1 to override or use --no-verify${NC}"
            exit 1
        fi
    else
        # Interactive mode
        read -p "Are you sure you want to continue? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${RED}[BLOCKED]${NC} Rebase cancelled"
            exit 1
        fi
    fi
fi

# 2. Ensure working directory is clean
if ! git diff-index --quiet HEAD --; then
    echo -e "${RED}[ERROR]${NC} Working directory is not clean"
    echo -e "${YELLOW}         Commit or stash your changes before rebasing${NC}"
    git status --short
    exit 1
fi

# 3. Warn if rebasing published commits
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
REMOTE_BRANCH="origin/$CURRENT_BRANCH"

if git rev-parse --verify "$REMOTE_BRANCH" >/dev/null 2>&1; then
    # Check if current branch has been pushed
    LOCAL_COMMIT=$(git rev-parse HEAD)
    REMOTE_COMMIT=$(git rev-parse "$REMOTE_BRANCH" 2>/dev/null || echo "")

    if [[ -n "$REMOTE_COMMIT" ]] && git merge-base --is-ancestor "$REMOTE_COMMIT" HEAD 2>/dev/null; then
        echo -e "${YELLOW}[WARNING]${NC} This branch has been pushed to remote"
        echo -e "${YELLOW}         Rebasing will rewrite public history${NC}"
        echo -e "${YELLOW}         You will need to force push after rebasing${NC}"

        # Check for non-interactive mode
        if [[ ! -t 0 ]] || [[ -n "$CI" ]] || [[ -n "$GITHUB_ACTIONS" ]] || [[ -n "$GITLAB_CI" ]]; then
            if [[ "$ALLOW_REBASE_PUBLIC" == "1" ]]; then
                echo -e "${YELLOW}[ALLOWED]${NC} Non-interactive mode with ALLOW_REBASE_PUBLIC=1"
            else
                echo -e "${RED}[BLOCKED]${NC} Cannot rebase published commits in non-interactive mode"
                echo -e "${YELLOW}           Set ALLOW_REBASE_PUBLIC=1 to override or use --no-verify${NC}"
                exit 1
            fi
        else
            # Interactive mode
            read -p "Continue with rebase? [y/N] " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo -e "${RED}[BLOCKED]${NC} Rebase cancelled"
                exit 1
            fi
        fi
    fi
fi

# 4. Check for active merge/rebase
if [[ -d ".git/rebase-merge" ]] || [[ -d ".git/rebase-apply" ]]; then
    echo -e "${RED}[ERROR]${NC} A rebase is already in progress"
    echo -e "${YELLOW}         Complete or abort the current rebase first${NC}"
    echo -e "${YELLOW}         git rebase --continue / --abort${NC}"
    exit 1
fi

if [[ -f ".git/MERGE_HEAD" ]]; then
    echo -e "${RED}[ERROR]${NC} A merge is in progress"
    echo -e "${YELLOW}         Complete or abort the current merge first${NC}"
    echo -e "${YELLOW}         git merge --continue / --abort${NC}"
    exit 1
fi

# 5. Show what will be rebased
echo -e "${BLUE}[INFO]${NC} Rebase summary:"
echo -e "${BLUE}        From:${NC} $UPSTREAM"
echo -e "${BLUE}        Branch:${NC} $BRANCH"

COMMITS_TO_REBASE=$(git log --oneline "$UPSTREAM".."$BRANCH" 2>/dev/null | wc -l | tr -d ' ')
echo -e "${BLUE}        Commits to rebase:${NC} $COMMITS_TO_REBASE"

if [[ $COMMITS_TO_REBASE -gt 0 ]]; then
    echo ""
    echo -e "${BLUE}[INFO]${NC} Commits that will be rebased:"
    git log --oneline "$UPSTREAM".."$BRANCH" | head -10
    if [[ $COMMITS_TO_REBASE -gt 10 ]]; then
        echo -e "${YELLOW}        ... and $((COMMITS_TO_REBASE - 10)) more${NC}"
    fi
fi

echo -e "${GREEN}[PASSED]${NC} Pre-rebase checks completed"
exit 0
