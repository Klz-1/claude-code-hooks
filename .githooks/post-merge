#!/bin/bash
# Git Post-Merge Hook
# Automates dependency installation and cleanup after merge

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}[POST-MERGE]${NC} Running post-merge automation..."

GIT_ROOT=$(git rev-parse --show-toplevel)
cd "$GIT_ROOT"

ACTIONS_TAKEN=false

# 1. Check if package.json changed
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD 2>/dev/null | grep -qE '^package\.json$'; then
    echo -e "${YELLOW}[DETECTED]${NC} package.json changed"

    if [[ -f "package-lock.json" ]]; then
        echo -e "${BLUE}[ACTION]${NC} Running npm install..."
        if npm install; then
            echo -e "${GREEN}[SUCCESS]${NC} Dependencies updated"
            ACTIONS_TAKEN=true
        else
            echo -e "${RED}[ERROR]${NC} npm install failed"
        fi
    elif [[ -f "yarn.lock" ]]; then
        echo -e "${BLUE}[ACTION]${NC} Running yarn install..."
        if yarn install; then
            echo -e "${GREEN}[SUCCESS]${NC} Dependencies updated"
            ACTIONS_TAKEN=true
        else
            echo -e "${RED}[ERROR]${NC} yarn install failed"
        fi
    elif [[ -f "pnpm-lock.yaml" ]]; then
        echo -e "${BLUE}[ACTION]${NC} Running pnpm install..."
        if pnpm install; then
            echo -e "${GREEN}[SUCCESS]${NC} Dependencies updated"
            ACTIONS_TAKEN=true
        else
            echo -e "${RED}[ERROR]${NC} pnpm install failed"
        fi
    fi
fi

# 2. Check if Python dependencies changed
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD 2>/dev/null | grep -qE '^requirements\.txt$'; then
    echo -e "${YELLOW}[DETECTED]${NC} requirements.txt changed"

    if command -v pip >/dev/null 2>&1; then
        echo -e "${BLUE}[ACTION]${NC} Running pip install..."
        if pip install -r requirements.txt; then
            echo -e "${GREEN}[SUCCESS]${NC} Python dependencies updated"
            ACTIONS_TAKEN=true
        else
            echo -e "${RED}[ERROR]${NC} pip install failed"
        fi
    fi
fi

# 3. Check if Gemfile changed
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD 2>/dev/null | grep -qE '^Gemfile$'; then
    echo -e "${YELLOW}[DETECTED]${NC} Gemfile changed"

    if command -v bundle >/dev/null 2>&1; then
        echo -e "${BLUE}[ACTION]${NC} Running bundle install..."
        if bundle install; then
            echo -e "${GREEN}[SUCCESS]${NC} Gems updated"
            ACTIONS_TAKEN=true
        else
            echo -e "${RED}[ERROR]${NC} bundle install failed"
        fi
    fi
fi

# 4. Clean build artifacts if build config changed
BUILD_CONFIGS=(
    "tsconfig.json"
    "webpack.config.js"
    "vite.config.ts"
    "rollup.config.js"
    ".babelrc"
)

for config in "${BUILD_CONFIGS[@]}"; do
    if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD 2>/dev/null | grep -qE "^$config$"; then
        echo -e "${YELLOW}[DETECTED]${NC} $config changed"

        # Clean build directories
        if [[ -d "dist" ]]; then
            echo -e "${BLUE}[ACTION]${NC} Cleaning dist/ directory..."
            rm -rf dist/
            ACTIONS_TAKEN=true
        fi

        if [[ -d "build" ]]; then
            echo -e "${BLUE}[ACTION]${NC} Cleaning build/ directory..."
            rm -rf build/
            ACTIONS_TAKEN=true
        fi

        echo -e "${GREEN}[SUCCESS]${NC} Build artifacts cleaned"
        break
    fi
done

# 5. Check if migration files changed (database migrations)
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD 2>/dev/null | grep -qE '(migrations?|db/migrate)'; then
    echo -e "${YELLOW}[DETECTED]${NC} Database migration files changed"
    echo -e "${BLUE}[INFO]${NC} Remember to run database migrations:"
    echo -e "${BLUE}        npm run migrate (or your migration command)${NC}"
fi

# 6. Check if .env.example changed
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD 2>/dev/null | grep -qE '^\.env\.example$'; then
    echo -e "${YELLOW}[DETECTED]${NC} .env.example changed"
    echo -e "${BLUE}[INFO]${NC} Update your .env file with new variables"

    if [[ -f ".env" ]]; then
        # Show new variables that might be missing
        echo -e "${BLUE}[INFO]${NC} New environment variables (check if you have these):"
        comm -23 <(grep -oE '^[A-Z_]+=' .env.example | sort) <(grep -oE '^[A-Z_]+=' .env | sort) | head -5
    fi
fi

# 7. Check if git hooks changed
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD 2>/dev/null | grep -qE '\.githooks/'; then
    echo -e "${YELLOW}[DETECTED]${NC} Git hooks changed"
    echo -e "${BLUE}[INFO]${NC} Run: git config core.hooksPath .githooks"
fi

# Summary
echo ""
if [[ "$ACTIONS_TAKEN" == "true" ]]; then
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}[COMPLETE]${NC} Post-merge actions completed"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
else
    echo -e "${BLUE}[INFO]${NC} No post-merge actions required"
fi

exit 0
