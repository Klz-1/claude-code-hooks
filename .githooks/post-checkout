#!/bin/bash
# Git Post-Checkout Hook
# Provides branch awareness and warnings after checkout

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Hook arguments
PREV_HEAD=$1
NEW_HEAD=$2
BRANCH_CHECKOUT=$3

# Only run on branch checkout (not file checkout)
if [[ "$BRANCH_CHECKOUT" != "1" ]]; then
    exit 0
fi

# Get current branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
GIT_ROOT=$(git rev-parse --show-toplevel)

echo ""
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${CYAN}  Branch Checkout Summary${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

# Show current branch prominently
if [[ "$CURRENT_BRANCH" == "main" ]] || [[ "$CURRENT_BRANCH" == "master" ]]; then
    echo -e "${RED}  ⚠️  On protected branch:${NC} ${RED}$CURRENT_BRANCH${NC}"
    echo -e "${YELLOW}      Be careful making changes directly on this branch${NC}"
else
    echo -e "${GREEN}  ✓ Current branch:${NC} ${CYAN}$CURRENT_BRANCH${NC}"
fi

# Show commits ahead/behind remote
if git rev-parse @{u} >/dev/null 2>&1; then
    AHEAD=$(git rev-list --count @{u}..HEAD 2>/dev/null || echo 0)
    BEHIND=$(git rev-list --count HEAD..@{u} 2>/dev/null || echo 0)

    if [[ $AHEAD -gt 0 ]] && [[ $BEHIND -gt 0 ]]; then
        echo -e "${YELLOW}  ↕ Branch status:${NC} $AHEAD commits ahead, $BEHIND commits behind remote"
    elif [[ $AHEAD -gt 0 ]]; then
        echo -e "${GREEN}  ↑ Branch status:${NC} $AHEAD commits ahead of remote"
    elif [[ $BEHIND -gt 0 ]]; then
        echo -e "${YELLOW}  ↓ Branch status:${NC} $BEHIND commits behind remote (consider pulling)"
    else
        echo -e "${GREEN}  ✓ Branch status:${NC} Up to date with remote"
    fi
else
    echo -e "${BLUE}  ℹ Branch status:${NC} No remote tracking branch"
fi

# Show uncommitted changes
UNCOMMITTED=$(git status --porcelain | wc -l | tr -d ' ')
if [[ $UNCOMMITTED -gt 0 ]]; then
    echo -e "${YELLOW}  ⚠ Uncommitted changes:${NC} $UNCOMMITTED file(s) modified"
    echo -e "${YELLOW}      Run 'git status' to see details${NC}"
fi

# Show stashed changes
STASHED=$(git stash list | wc -l | tr -d ' ')
if [[ $STASHED -gt 0 ]]; then
    echo -e "${BLUE}  📦 Stashed changes:${NC} $STASHED stash(es) available"
    echo -e "${BLUE}      Run 'git stash list' to see details${NC}"
fi

# Check for dependencies changes (package.json, requirements.txt, etc.)
if [[ "$PREV_HEAD" != "$NEW_HEAD" ]]; then
    echo ""
    echo -e "${BLUE}  🔍 Checking for dependency changes...${NC}"

    DEPS_CHANGED=false

    # JavaScript/Node
    if git diff --name-only "$PREV_HEAD" "$NEW_HEAD" 2>/dev/null | grep -qE '^(package\.json|package-lock\.json|yarn\.lock|pnpm-lock\.yaml)$'; then
        echo -e "${YELLOW}  ⚠ package.json changed${NC}"
        echo -e "${YELLOW}      Consider running: npm install${NC}"
        DEPS_CHANGED=true
    fi

    # Python
    if git diff --name-only "$PREV_HEAD" "$NEW_HEAD" 2>/dev/null | grep -qE '^(requirements\.txt|Pipfile|Pipfile\.lock|pyproject\.toml)$'; then
        echo -e "${YELLOW}  ⚠ Python dependencies changed${NC}"
        echo -e "${YELLOW}      Consider running: pip install -r requirements.txt${NC}"
        DEPS_CHANGED=true
    fi

    # Ruby
    if git diff --name-only "$PREV_HEAD" "$NEW_HEAD" 2>/dev/null | grep -qE '^(Gemfile|Gemfile\.lock)$'; then
        echo -e "${YELLOW}  ⚠ Gemfile changed${NC}"
        echo -e "${YELLOW}      Consider running: bundle install${NC}"
        DEPS_CHANGED=true
    fi

    if [[ "$DEPS_CHANGED" == "false" ]]; then
        echo -e "${GREEN}  ✓ No dependency changes detected${NC}"
    fi
fi

# Branch naming convention reminder
if [[ ! "$CURRENT_BRANCH" =~ ^(main|master|develop|staging|production)$ ]]; then
    # Check if branch follows convention (e.g., feature/*, bugfix/*, etc.)
    if [[ ! "$CURRENT_BRANCH" =~ ^(feature|bugfix|hotfix|release|chore|docs|test)/ ]]; then
        echo ""
        echo -e "${BLUE}  💡 Branch Naming Convention:${NC}"
        echo -e "${BLUE}      feature/description  - New features${NC}"
        echo -e "${BLUE}      bugfix/description   - Bug fixes${NC}"
        echo -e "${BLUE}      hotfix/description   - Urgent fixes${NC}"
        echo -e "${BLUE}      chore/description    - Maintenance tasks${NC}"
    fi
fi

# Show last commit on this branch
echo ""
echo -e "${BLUE}  📝 Last commit:${NC}"
git log -1 --pretty=format:"      %C(yellow)%h%Creset - %s %C(dim)(%cr)%Creset" 2>/dev/null
echo ""

echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
