#!/bin/bash
# Git Commit-Msg Hook
# Validates commit message format and adds metadata

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip if this is a merge commit
if git rev-parse -q --verify MERGE_HEAD >/dev/null 2>&1; then
    exit 0
fi

# Skip if commit message is from --amend or --fixup
if [[ "$COMMIT_MSG" =~ ^(fixup!|squash!) ]]; then
    exit 0
fi

echo -e "${BLUE}[COMMIT-MSG]${NC} Validating commit message..."

ERRORS=0

# 1. Check minimum length
MIN_LENGTH=10
MSG_LENGTH=${#COMMIT_MSG}

if [[ $MSG_LENGTH -lt $MIN_LENGTH ]]; then
    echo -e "${RED}[ERROR]${NC} Commit message too short ($MSG_LENGTH chars, minimum $MIN_LENGTH)"
    ERRORS=$((ERRORS + 1))
fi

# 2. Check maximum first line length
FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)
MAX_FIRST_LINE=72

if [[ ${#FIRST_LINE} -gt $MAX_FIRST_LINE ]]; then
    echo -e "${YELLOW}[WARNING]${NC} First line is long (${#FIRST_LINE} chars, recommended max $MAX_FIRST_LINE)"
fi

# 3. Optional: Enforce conventional commits format
# Uncomment the following to enforce conventional commits:
#
# CONVENTIONAL_PATTERN='^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+'
#
# if [[ ! "$FIRST_LINE" =~ $CONVENTIONAL_PATTERN ]]; then
#     echo -e "${RED}[ERROR]${NC} Commit message doesn't follow conventional commits format"
#     echo -e "${YELLOW}         Expected: type(scope): description${NC}"
#     echo -e "${YELLOW}         Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert${NC}"
#     echo -e "${YELLOW}         Example: feat(auth): add login functionality${NC}"
#     ERRORS=$((ERRORS + 1))
# fi

# 4. Check for common mistakes
if [[ "$FIRST_LINE" =~ ^(Updated|Fixed|Changed) ]]; then
    echo -e "${YELLOW}[WARNING]${NC} Use imperative mood: 'Update' not 'Updated', 'Fix' not 'Fixed'"
fi

if [[ "$COMMIT_MSG" =~ \.$  ]]; then
    echo -e "${YELLOW}[WARNING]${NC} Don't end commit message with a period"
fi

# 5. Check for issue/ticket references (optional)
# Uncomment to require ticket references:
#
# if [[ ! "$COMMIT_MSG" =~ (JIRA-[0-9]+|#[0-9]+|Fixes|Closes|Resolves) ]]; then
#     echo -e "${YELLOW}[WARNING]${NC} Consider referencing an issue/ticket"
#     echo -e "${YELLOW}         Examples: Fixes #123, Resolves JIRA-456${NC}"
# fi

# 6. Add branch name to commit message (if not already present)
BRANCH_NAME=$(git symbolic-ref --short HEAD 2>/dev/null)

if [[ -n "$BRANCH_NAME" ]] && [[ ! "$BRANCH_NAME" =~ ^(main|master|develop)$ ]]; then
    # Extract ticket number from branch name if present
    TICKET=$(echo "$BRANCH_NAME" | grep -oE '([A-Z]+-[0-9]+|#[0-9]+)' | head -1)

    if [[ -n "$TICKET" ]] && [[ ! "$COMMIT_MSG" =~ $TICKET ]]; then
        echo "" >> "$COMMIT_MSG_FILE"
        echo "[Branch: $BRANCH_NAME]" >> "$COMMIT_MSG_FILE"
        if [[ -n "$TICKET" ]]; then
            echo "Refs: $TICKET" >> "$COMMIT_MSG_FILE"
        fi
        echo -e "${BLUE}[INFO]${NC} Added branch reference to commit message"
    fi
fi

# Final result
if [[ $ERRORS -gt 0 ]]; then
    echo -e "${RED}[BLOCKED]${NC} Commit message validation failed"
    echo ""
    echo "Your commit message:"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "$COMMIT_MSG"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "Please write a more descriptive commit message."
    echo "To bypass this hook (NOT recommended), use: git commit --no-verify"
    exit 1
else
    echo -e "${GREEN}[SUCCESS]${NC} Commit message validated"
    exit 0
fi
